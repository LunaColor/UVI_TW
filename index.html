<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Taiwan UVI now</title>

    <link href="objects/css/style.css" rel="stylesheet" type="text/css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>-->
    <!--google map放大縮小時，用Bootstrap調RWD畫面會有重排的震動狀況，故此處不用-->
    <script>
        var markerMap = new Map();
        var lastScrollY = 0;
        var getLocationable = false;
        var uvi_map;
        $(function () {
            uvi_map = new google.maps.Map($('#uviMap').get(0), {//###建立地圖
                zoom: 8, center: { lat: 23.64, lng: 120.20 }//雲林
            });

            if (navigator.geolocation) {
                getLocationable = true;
                navigator.geolocation.getCurrentPosition(hereSetUp);//###加自身位置marker
            };

            $.ajax({
                url: 'https://opendata.epa.gov.tw/ws/Data/UV/?$format=json',
                dataType: 'jsonp',
                success: addUviMakers,//###加uvi位置&資訊marker
                error: function (x) {
                    console.log('*********<br/> error code:' + x.status);
                }
            })

            $(window).resize(function () {
                if (window.matchMedia("(min-width: 769px)").matches) {/*--->the viewport at least 769 pixels wide!*/
                    if (getLocationable) {
                        uvi_map.setCenter({ lat: 23.64, lng: 120.20 });//雲林
                    }
                }
                else {
                    if (getLocationable) {
                        uvi_map.setCenter(markerMap.get('here').position);//現在位置
                    }
                }
            })

            window.addEventListener('scroll', function () {
                var startScrollY = this.scrollY;
                if (startScrollY <= lastScrollY) {/*往上滾*/
                    $('header').removeClass('hide');
                }
                else {
                    $('header').addClass('hide');
                }
                lastScrollY = startScrollY;
            })
        });

        //自身位置marker相關S-----------------------------------------
        function hereSetUp(pos) {
            addMarkerHere(pos, setCenterhere);
        }

        function addMarkerHere(pos, callback) {
            var marker = new google.maps.Marker({
                position: {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                },
                map: uvi_map,
                title: 'Here you are!'
            });
            markerMap.set('here', marker);
            if (callback != null && typeof callback == 'function') {
                callback();
            }
        }

        function setCenterhere() {
            if ($(window).width() < 769) {
                uvi_map.setCenter(markerMap.get('here').position);//現在位置
            }
        }
        //自身位置相關E-----------------------------------------
        //uvi位置&資訊marker相關S-----------------------------------------
        function addUviMakers(date) {
            var atNight = true;
            if (date == null) {
                alert('open date 無資料!');
                return;
            }

            $.each(date, function () {
                //位置
                var latlng = {
                    lat: getWGS84Value(this.WGS84Lat),
                    lng: getWGS84Value(this.WGS84Lon)
                };

                //紫外線指數+icon圖示
                var uvi = parseInt(this.UVI);
                var iconName;
                if (uvi != 0) {//有一個地方uvi不是0就不算晚上!
                    atNight = false;
                };

                if (isNaN(uvi)) {//非數字，紫外線指數設null!
                    uvi = null;
                    iconName = 'question';
                }
                else {
                    if (uvi < 3) {
                        iconName = 'cloud';
                    }
                    else if (uvi >= 3 && uvi < 6) {
                        iconName = 'cloudSun';
                    }
                    else if (uvi >= 6 && uvi < 8) {
                        iconName = 'sun';
                    }
                    else if (uvi >= 8) {
                        iconTName = 'flame';
                    };
                };

                //add marker!
                var marker = new google.maps.Marker({
                    position: latlng,
                    map: uvi_map,
                    title: this.County + this.SiteName + '，UVI : ' + (uvi == null ? 'unknown' : uvi.toString()),
                    label: getUviMarkerLabel(uvi),
                    icon: 'src/images/' + iconName + '.png'
                });
                markerMap.set(latlng, marker);
            });
            if (atNight == true) { setAllMarkersNight(); };
        };

        //WGS84經緯度(60進位度分秒)轉--->WGS84十進位數字 for google map!
        function getWGS84Value(WGS84L) {
            var arr = WGS84L.split(',');
            return parseFloat(arr[0])//度
                + parseFloat(arr[1] / 60)//分
                + parseFloat(arr[2] / (60 * 60));//秒
        }

        function getUviMarkerLabel(uvi) {
            //'0~9'or'H'or'null'!
            return uvi == null ? null :
                uvi > 9 ? 'H' ://因google marker label只能單'src/images/' + iconName + '.png'字元!
                    uvi.toString();
        }

        //全點uvi=0->除自身位置全點設晚上!
        function setAllMarkersNight() {
            //var [key, value]
            for (var [key, marker] of markerMap) {
                if (key == 'here') {//跳過自身位置!
                    continue;
                }
                marker.setIcon('src/images/moon.png');
                marker.setLabel(null);
            };
        }
        //uvi位置&資訊marker相關S-----------------------------------------
    </script>
</head>

<body>
    <header>
        <a>全台紫外線指數<br />即時資訊</a>
    </header>
    <div id="cont">
        <div id="mapContainer">
            <div id="uviMap"></div>
        </div>
        <div id="desc">
            <table>
                <thead>
                    <tr style='color:#335500'>
                        <th colspan="4">
                            <p>圖示說明</p>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr style='color:#55cc00'>
                        <td><img src="src/images/cloud.png"></td>
                        <td>UVI 0~2</td>
                        <td>低</td>
                        <td></td>
                    </tr>
                    <tr style='color:#88aa00'>
                        <td><img src="src/images/cloudSun.png"></td>
                        <td>UVI 3~5</td>
                        <td>中</td>
                        <td></td>
                    </tr>
                    <tr style='color:#ff7700'>
                        <td><img src="src/images/sun.png"></td>
                        <td>UVI 6~7</td>
                        <td>高</td>
                        <td>30min曬傷</td>
                    </tr>
                    <tr style='color:#ff3300'>
                        <td><img src="src/images/flame.png"></td>
                        <td>UVI 8up</td>
                        <td>過量</td>
                        <td>20min曬傷</td>
                    </tr>
                    <tr style='color:#224466'>
                        <td><img src="src/images/moon.png"></td>
                        <td colspan="3">夜晚</td>
                    </tr>
                    <tr style='color:#777799'>
                        <td><img src="src/images/question.png"></td>
                        <td colspan="3">uvi數值無法確認</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>
<!--Thank's https://www.flaticon.com for many cute icon!-->
<!--Thank's https://data.gov.tw/dataset/6076 for uvi immediate information!-->
<!--Thank's https://www.cwb.gov.tw/V7/forecast/UVI/UVI.htm for uvi description!-->